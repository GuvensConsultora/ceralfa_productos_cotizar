<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ==================== SERVER ACTION ==================== -->
    <!-- Por qué: server action con código inline evita _inherit sobre el modelo Studio.
         No requiere studio_customization en depends (causa "inconsistent states").
         Se llama desde el botón "Cotizar" en el <header> de la list view. -->
    <record id="action_cotizar_server" model="ir.actions.server">
        <field name="name">Cotizar - Crear RFQ</field>
        <field name="model_id" search="[('model','=','x_productos_a_cotizar')]"/>
        <field name="state">code</field>
        <field name="code">
# Agrupar registros seleccionados por (moneda, compañía)
groups = {}
for rec in records:
    key = (
        rec.x_studio_currency_id.id or env.company.currency_id.id,
        rec.x_studio_compaia.id if rec.x_studio_compaia else env.company.partner_id.id,
    )
    groups.setdefault(key, records.browse())
    groups[key] |= rec

created_ids = []
for (currency_id, company_id), recs in groups.items():
    # Fecha de entrega: la más temprana del grupo
    primer_entrega = min(recs, key=lambda r: r.x_studio_date_stop or r.create_date)
    po = env['purchase.order'].create({
        'partner_id': company_id,
        'currency_id': currency_id,
        'company_id': company_id,
        'date_order': primer_entrega.x_studio_date_stop,
    })
    for rec in recs:
        product = env['product.template'].browse(rec.x_studio_producto.id)
        env['purchase.order.line'].create({
            'order_id': po.id,
            'product_id': product.product_variant_id.id,
            'product_qty': rec.x_studio_cantidad,
            'price_unit': product.standard_price,
            # Odoo 19 asigna UoM automáticamente desde el producto
            'name': rec.x_name,
            'date_planned': primer_entrega.x_studio_date_stop,
        })
    # Vincular cada registro con su línea de PO
    for po_line in po.order_line:
        matching = recs.filtered(lambda r: r.x_name == po_line.name)
        if matching:
            matching[0].write({
                'x_studio_ppto_comp': po.id,
                'x_studio_linea_ppto_cpras': po_line.id,
                'x_studio_stage_id': 2,
            })
    created_ids.append(po.id)

# Retornar acción para ver las POs creadas
if len(created_ids) == 1:
    action = {
        'type': 'ir.actions.act_window',
        'res_model': 'purchase.order',
        'res_id': created_ids[0],
        'view_mode': 'form',
        'target': 'current',
    }
else:
    action = {
        'type': 'ir.actions.act_window',
        'res_model': 'purchase.order',
        'domain': [('id', 'in', created_ids)],
        'view_mode': 'list,form',
        'target': 'current',
    }
        </field>
    </record>

    <!-- ==================== LIST VIEW ==================== -->
    <!-- Por qué: vista propia para x_productos_a_cotizar.
         Usa botón type="action" que llama al server action (no requiere método Python).
         priority=1 para que se use antes que la vista Studio. -->
    <record id="x_productos_cotizar_list_view" model="ir.ui.view">
        <field name="name">x_productos_a_cotizar.list.ceralfa</field>
        <field name="model">x_productos_a_cotizar</field>
        <field name="priority">1</field>
        <field name="arch" type="xml">
            <list string="Productos a Cotizar" multi_edit="1">
                <header>
                    <button name="%(action_cotizar_server)d" type="action"
                            string="Coti Compra" class="btn-primary"/>
                </header>
                <field name="x_studio_date" string="Fecha"/>
                <field name="x_studio_cliente" string="Cliente"/>
                <field name="x_studio_date_start" string="Periodo del proceso"/>
                <field name="x_studio_date_stop" string="Fecha de finalización"/>
                <field name="x_studio_producto" string="Producto"/>
                <field name="x_studio_categoria" string="Categoría"/>
                <field name="x_studio_cantidad" string="Cantidad"/>
                <field name="x_studio_divisa_en_compras" string="Divisa Compras"/>
                <field name="x_studio_valor_cpra" string="Valor Compra Inicial"/>
                <field name="x_studio_currency_id" string="Div Vtas"/>
                <field name="x_studio_margen" string="Margen"/>
                <field name="x_studio_val_vtas_calc" string="Val Vtas Calc."/>
                <field name="x_studio_presupuesto_de_vtas" string="Ppto Vtas"/>
                <field name="x_studio_val_cpra_final" string="Valor Compra Final"/>
                <field name="x_studio_ppto_comp" string="Presup. Compra"/>
                <field name="x_studio_stage_id" string="Etapa" widget="badge"/>
                <field name="x_studio_kanban_state" string="Estado Fact Vta"/>
                <field name="x_studio_compaia" string="Compañía"/>
                <field name="x_color" string="Color" optional="hide"/>
            </list>
        </field>
    </record>

    <!-- ==================== ACTION WINDOW ==================== -->
    <record id="action_x_productos_cotizar" model="ir.actions.act_window">
        <field name="name">Productos a Cotizar</field>
        <field name="res_model">x_productos_a_cotizar</field>
        <field name="view_mode">list,form,kanban</field>
        <field name="view_id" ref="x_productos_cotizar_list_view"/>
    </record>

    <!-- ==================== MENÚ ==================== -->
    <menuitem id="menu_x_productos_cotizar"
        name="Productos a Cotizar"
        action="action_x_productos_cotizar"
        parent="purchase.menu_procurement_management"
        sequence="10"/>

</odoo>
